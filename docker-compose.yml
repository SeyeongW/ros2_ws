version: '3.8'

services:
  # 1. 비행 제어 노드 (기존 유지)
  vtol_mission:
    build:
      context: ./mission
    image: vtol_mission:local
    container_name: vtol_mission
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    devices:
      - "/dev/ttyAMA0:/dev/serial0"
    command: >
      bash -c "source /opt/ros/humble/setup.bash &&
      source /ros2_ws/install/setup.bash &&
      ros2 launch vtol_mission takeoff.launch.py fcu_url:=/dev/serial0:57600 system_id:=255 component_id:=240"

  # 2. AI 영상 노드 (Hailo-8 Vision)
  siyi_vision:
    build:
      context: ./vision_project
    image: siyi_vision:local
    container_name: siyi_vision
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    
    environment:
      - GST_DEBUG=0
      # [핵심 1] GStreamer에게 "호스트에서 가져온 플러그인을 써라"고 명령
      - GST_PLUGIN_PATH=/host_fs/usr/lib/aarch64-linux-gnu/gstreamer-1.0
      
      # [핵심 2] 라이브러리 우선순위 변경 (치트키)
      # 도커 내부 라이브러리보다 "마운트된 호스트 라이브러리(/host_fs/...)"를 먼저 보게 만듭니다.
      # 이렇게 하면 OpenCV, Hailo, GStreamer 등 모든 의존성이 호스트와 똑같이 맞춰집니다.
      - LD_LIBRARY_PATH=/host_fs/usr/lib/aarch64-linux-gnu:/host_fs/usr/lib:/host_fs/lib/aarch64-linux-gnu:/usr/lib/aarch64-linux-gnu:/usr/lib

    devices:
      - "/dev/hailo0:/dev/hailo0"
    
    volumes:
      - /dev:/dev
      # (1) 코드 및 모델 파일
      - ./vision_project/siyi_pose_node.py:/root/ws/siyi_pose_node.py
      - /home/sw/hailo-rpi5-examples/resources/models/hailo8/yolov8m_pose.hef:/root/model.hef:ro
      - /home/sw/hailo-rpi5-examples:/hailo_ws:ro
      
      # (2) [핵심] 호스트의 시스템 폴더 전체를 /host_fs 라는 이름으로 마운트
      # 이제 도커 안에서 /host_fs/usr/lib 로 접근하면 호스트의 라이브러리를 다 쓸 수 있습니다.
      - /usr/lib:/host_fs/usr/lib:ro
      - /lib:/host_fs/lib:ro

    # [실행 명령] 복사할 필요 없음! 바로 실행합니다.
    command:
      - bash
      - -c
      - |
        set -e
        echo "--- Setting up Hailo Vision Node (Host-Passthrough Mode) ---"
        
        # 1. 모델 파일 확인
        if [ ! -f /root/model.hef ]; then
            echo "CRITICAL: Model file not mounted!"
            exit 1
        fi
        
        # 2. 링커 캐시 갱신 (호스트 라이브러리 인식)
        ldconfig

        # 3. 플러그인 검사 (이게 성공해야 함)
        echo "Inspecting Hailonet using HOST libraries..."
        gst-inspect-1.0 hailonet

        # 4. 실행
        echo "Starting Node..."
        python3 /root/ws/siyi_pose_node.py --ros-args -p hef_path:=/root/model.hef
