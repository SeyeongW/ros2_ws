version: '3.8'

services:
  # 1. 비행 제어 노드 (기존 유지)
  vtol_mission:
    build:
      context: ./mission
    image: vtol_mission:local
    container_name: vtol_mission
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    devices:
      - "/dev/ttyAMA0:/dev/serial0"
    command: >
      bash -c "source /opt/ros/humble/setup.bash &&
      source /ros2_ws/install/setup.bash &&
      ros2 launch vtol_mission takeoff.launch.py fcu_url:=/dev/serial0:57600 system_id:=255 component_id:=240"

  # 2. AI 영상 노드 (Hailo-8 Vision)
  siyi_vision:
    build:
      context: ./vision_project
    image: siyi_vision:local
    container_name: siyi_vision
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    
    environment:
      - GST_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/gstreamer-1.0
      - LD_LIBRARY_PATH=/usr/lib/aarch64-linux-gnu:/usr/lib
      - PYTHONPATH=/usr/lib/python3/dist-packages

    devices:
      - "/dev/hailo0:/dev/hailo0"
    
    volumes:
      - /dev:/dev
      # (1) 모델 파일 및 코드
      - /home/sw/hailo-rpi5-examples:/hailo_ws
      - ./vision_project/siyi_pose_node.py:/root/ws/siyi_pose_node.py
      
      # (2) [수정됨] 특정 경로 대신 시스템 라이브러리 폴더 전체를 검색용으로 마운트 (읽기 전용)
      - /usr/lib:/host_usr_lib:ro
      - /usr/local/lib:/host_local_lib:ro

      # (3) 파이썬 패키지 (경로가 다를 수 있으니 가능한 모든 경로 마운트)
      - /usr/lib/python3/dist-packages:/usr/lib/python3/dist-packages
      - /usr/local/lib/python3/dist-packages:/usr/local/lib/python3/dist-packages

    # [핵심] find 명령어로 파일 위치를 스스로 찾아서 복사하도록 개선
    command: >
      bash -c "
      echo 'Searching and setting up Hailo libraries...' &&
      
      # 1. 라이브러리 파일 찾아서 복사 (어디에 있든 찾아냄)
      find /host_usr_lib /host_local_lib -name 'libhailort.so*' -exec cp -fpv {} /usr/lib/aarch64-linux-gnu/ \; &&
      find /host_usr_lib /host_local_lib -name 'libgsthailometa.so*' -exec cp -fpv {} /usr/lib/aarch64-linux-gnu/ \; &&
      find /host_usr_lib /host_local_lib -name 'libhailo_tracker.so*' -exec cp -fpv {} /usr/lib/aarch64-linux-gnu/ \; &&
      
      # 2. GStreamer 플러그인 찾아서 복사
      find /host_usr_lib /host_local_lib -name 'libgsthailo.so' -exec cp -fpv {} /usr/lib/aarch64-linux-gnu/gstreamer-1.0/ \; &&
      find /host_usr_lib /host_local_lib -name 'libgsthailotools.so' -exec cp -fpv {} /usr/lib/aarch64-linux-gnu/gstreamer-1.0/ \; &&
      
      # 3. 버전 호환성을 위한 심볼릭 링크 생성 (4.20.0이 없으면 4.17.0 등으로 연결)
      echo 'Creating symlinks...' &&
      ln -sf /usr/lib/aarch64-linux-gnu/libhailort.so /usr/lib/aarch64-linux-gnu/libhailort.so.4.20.0 &&
      
      echo 'Starting Node...' &&
      python3 /root/ws/siyi_pose_node.py
      "
#cd ~/ros2_ws
#docker compose up --build siyi_vision