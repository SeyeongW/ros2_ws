version: '3.8'

services:
  # 1. 비행 제어 노드 (기존 유지)
  vtol_mission:
    build:
      context: ./mission
    image: vtol_mission:local
    container_name: vtol_mission
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    devices:
      - "/dev/ttyAMA0:/dev/serial0"
    command: >
      bash -c "source /opt/ros/humble/setup.bash &&
      source /ros2_ws/install/setup.bash &&
      ros2 launch vtol_mission takeoff.launch.py fcu_url:=/dev/serial0:57600 system_id:=255 component_id:=240"

  # 2. AI 영상 노드 (Hailo-8 Vision)
  siyi_vision:
    build:
      context: ./vision_project
    image: siyi_vision:local
    container_name: siyi_vision
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    
    environment:
      # [디버그] 왜 로딩 안되는지 상세히 보기 (레벨 3)
      - GST_DEBUG=3
      # 플러그인 경로 명시
      - GST_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/gstreamer-1.0
      - LD_LIBRARY_PATH=/usr/lib/aarch64-linux-gnu:/usr/lib

    devices:
      - "/dev/hailo0:/dev/hailo0"
    
    volumes:
      - /dev:/dev
      # (1) 모델 파일 및 코드
      - /home/sw/hailo-rpi5-examples:/hailo_ws
      - ./vision_project/siyi_pose_node.py:/root/ws/siyi_pose_node.py
      
      # (2) [핵심] 파일을 복사하지 않고, 제자리에 바로 마운트 (실패 확률 0%)
      
      # Hailo 런타임 라이브러리 (호스트에 4.20.0이 있다고 하셨으므로)
      - /usr/lib/aarch64-linux-gnu/libhailort.so.4.20.0:/usr/lib/aarch64-linux-gnu/libhailort.so.4.20.0
      # 심볼릭 링크 이름으로도 연결 (도커가 libhailort.so를 찾을 때 위 파일을 보게 함)
      - /usr/lib/aarch64-linux-gnu/libhailort.so.4.20.0:/usr/lib/aarch64-linux-gnu/libhailort.so

      # 메타 라이브러리 (호스트에 있다고 확인된 경로)
      - /usr/lib/aarch64-linux-gnu/libgsthailometa.so:/usr/lib/aarch64-linux-gnu/libgsthailometa.so

      # GStreamer 플러그인 (hailonet)
      - /usr/lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailo.so:/usr/lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailo.so
      - /usr/lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailotools.so:/usr/lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailotools.so

    # 실행 명령 단순화 (복사 과정 삭제)
    command: >
      bash -c "
      echo 'Step 1: Cleaning Cache...' &&
      rm -rf /root/.cache/gstreamer-1.0 &&
      
      echo 'Step 2: Checking Libraries...' &&
      ls -l /usr/lib/aarch64-linux-gnu/libhailort.so &&
      ls -l /usr/lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailo.so &&
      
      echo 'Step 3: Updating Linker...' &&
      ldconfig &&
      
      echo 'Step 4: Inspecting Hailonet...' &&
      # 여기서 에러가 나면 GST_DEBUG 덕분에 이유가 뜰 겁니다.
      gst-inspect-1.0 hailonet && 
      
      echo 'Step 5: Starting Node...' &&
      python3 /root/ws/siyi_pose_node.py
      "
