version: '3.8'

services:
  # 1. ë¹„í–‰ ì œì–´ ë…¸ë“œ (ê¸°ì¡´ ìœ ì§€)
  vtol_mission:
    build:
      context: ./mission
    image: vtol_mission:local
    container_name: vtol_mission
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    devices:
      - "/dev/ttyAMA0:/dev/serial0"
    command: >
      bash -c "source /opt/ros/humble/setup.bash &&
      source /ros2_ws/install/setup.bash &&
      ros2 launch vtol_mission takeoff.launch.py fcu_url:=/dev/serial0:57600 system_id:=255 component_id:=240"

  # 2. AI ì˜ìƒ ë…¸ë“œ (Hailo-8 Vision)
  siyi_vision:
    build:
      context: ./vision_project
    image: siyi_vision:local
    container_name: siyi_vision
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    
    environment:
      - GST_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/gstreamer-1.0
      - LD_LIBRARY_PATH=/usr/lib/aarch64-linux-gnu:/usr/lib
      - PYTHONPATH=/usr/lib/python3/dist-packages

    devices:
      - "/dev/hailo0:/dev/hailo0"
    
    volumes:
      - /dev:/dev
      
      # (1) ëª¨ë¸ íŒŒì¼ ë° ì½”ë“œ
      - /home/sw/hailo-rpi5-examples:/hailo_ws
      - ./vision_project/siyi_pose_node.py:/root/ws/siyi_pose_node.py
      
      # (2) GStreamer í”ŒëŸ¬ê·¸ì¸
      - /usr/lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailo.so:/usr/lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailo.so
      - /usr/lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailotools.so:/usr/lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailotools.so

      # (3) [í•µì‹¬ ìˆ˜ì •] ëŸ°íƒ€ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ë²„ì „ ì†ì´ê¸°!)
      # í˜¸ìŠ¤íŠ¸ì˜ 4.17.0 íŒŒì¼ì„ -> ë„ì»¤ì—ê²ŒëŠ” 4.20.0 ì´ë¼ê³  ê±°ì§“ë§í•˜ê³  ë„£ì–´ì¤ë‹ˆë‹¤.
      - /usr/lib/aarch64-linux-gnu/libhailort.so.4.17.0:/usr/lib/aarch64-linux-gnu/libhailort.so.4.20.0
      # ì‹¬ë³¼ë¦­ ë§í¬ë„ ì—°ê²°
      - /usr/lib/aarch64-linux-gnu/libhailort.so.4.17.0:/usr/lib/aarch64-linux-gnu/libhailort.so

      # (4) [ì¶”ê°€ë¨] ë©”íƒ€ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì‚¬ìš©ìê°€ ì°¾ì€ íŒŒì¼)
      # í˜¸ìŠ¤íŠ¸ì˜ 3.31.0 íŒŒì¼ì„ -> ë„ì»¤ì—ê²ŒëŠ” í•„ìš”í•œ ì´ë¦„(.so.3)ìœ¼ë¡œ ë„£ì–´ì¤ë‹ˆë‹¤.
      - /usr/lib/aarch64-linux-gnu/libgsthailometa.so.3.31.0:/usr/lib/aarch64-linux-gnu/libgsthailometa.so.3
      - /usr/lib/aarch64-linux-gnu/libgsthailometa.so.3.31.0:/usr/lib/aarch64-linux-gnu/libgsthailometa.so

      # (5) íŒŒì´ì¬ íŒ¨í‚¤ì§€
      - /usr/lib/python3/dist-packages/hailort:/usr/lib/python3/dist-packages/hailort
      - /usr/lib/python3/dist-packages/hailo_platform:/usr/lib/python3/dist-packages/hailo_platform

    command: python3 /root/ws/siyi_pose_node.py

### ğŸš€ ì‹¤í–‰

#cd ~/ros2_ws
#docker compose up --build siyi_vision