version: '3.8'

services:
  # 1. ë¹„í–‰ ì œì–´ ë…¸ë“œ (ê¸°ì¡´ ìœ ì§€)
  vtol_mission:
    build:
      context: ./mission
    image: vtol_mission:local
    container_name: vtol_mission
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    devices:
      - "/dev/ttyAMA0:/dev/serial0"
    command: >
      bash -c "source /opt/ros/humble/setup.bash &&
      source /ros2_ws/install/setup.bash &&
      ros2 launch vtol_mission takeoff.launch.py fcu_url:=/dev/serial0:57600 system_id:=255 component_id:=240"

  # 2. AI ì˜ìƒ ë…¸ë“œ (Hailo-8 Vision)
  siyi_vision:
    build:
      context: ./vision_project
    image: siyi_vision:local
    container_name: siyi_vision
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    
    # [í™˜ê²½ ë³€ìˆ˜]
    environment:
      # GStreamer í”ŒëŸ¬ê·¸ì¸ ìœ„ì¹˜ ì§€ì •
      - GST_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/gstreamer-1.0
      # ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²½ë¡œ ì§€ì •
      - LD_LIBRARY_PATH=/usr/lib/aarch64-linux-gnu:/usr/lib
      # íŒŒì´ì¬ íŒ¨í‚¤ì§€ ê²½ë¡œ ì§€ì •
      - PYTHONPATH=/usr/lib/python3/dist-packages

    devices:
      - "/dev/hailo0:/dev/hailo0"
    
    # [í•µì‹¬ ìˆ˜ì •: ë³¼ë¥¨ ë§ˆìš´íŠ¸]
    # í´ë” ì „ì²´ë¥¼ ë§ˆìš´íŠ¸í•˜ì§€ ì•Šê³ , í•„ìš”í•œ íŒŒì¼ë§Œ ê°œë³„ì ìœ¼ë¡œ ë§ˆìš´íŠ¸í•˜ì—¬ ì¶©ëŒ ë°©ì§€
    volumes:
      - /dev:/dev
      
      # (1) ëª¨ë¸ íŒŒì¼ ë° ì½”ë“œ
      - /home/sw/hailo-rpi5-examples:/hailo_ws
      - ./vision_project/siyi_pose_node.py:/root/ws/siyi_pose_node.py
      
      # (2) GStreamer Hailo í”ŒëŸ¬ê·¸ì¸ (íŒŒì¼ë§Œ ì™ ê°€ì ¸ì˜¤ê¸°)
      - /usr/lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailo.so:/usr/lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailo.so
      - /usr/lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailotools.so:/usr/lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailotools.so

      # (3) Hailo ëŸ°íƒ€ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ (íŒŒì¼ë§Œ ì™ ê°€ì ¸ì˜¤ê¸°)
      # ì£¼ì˜: íŒŒì¼ëª… ë²„ì „(4.17.0)ì€ ë¼ì¦ˆë² ë¦¬íŒŒì´ ì„¤ì¹˜ ë²„ì „ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ í™•ì¸ í•„ìš”
      - /usr/lib/aarch64-linux-gnu/libhailort.so.4.17.0:/usr/lib/aarch64-linux-gnu/libhailort.so.4.17.0
      # ì‹¬ë³¼ë¦­ ë§í¬ ì—°ê²° (ë„ì»¤ê°€ libhailort.soë¥¼ ì°¾ì„ ë•Œ ìœ„ íŒŒì¼ì„ ë³´ê²Œ í•¨)
      - /usr/lib/aarch64-linux-gnu/libhailort.so.4.17.0:/usr/lib/aarch64-linux-gnu/libhailort.so

      # (4) íŒŒì´ì¬ íŒ¨í‚¤ì§€ (ì´ê±´ í´ë”ì§¸ë¡œ ê°€ì ¸ì™€ë„ ì•ˆì „í•¨)
      - /usr/lib/python3/dist-packages/hailort:/usr/lib/python3/dist-packages/hailort
      - /usr/lib/python3/dist-packages/hailo_platform:/usr/lib/python3/dist-packages/hailo_platform

    command: python3 /root/ws/siyi_pose_node.py

### ğŸš€ ì‹¤í–‰ ë°©ë²•
#cd ~/ros2_ws
#docker compose up --build siyi_vision