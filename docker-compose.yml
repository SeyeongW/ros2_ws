version: '3.8'

services:
  # 1. 비행 제어 노드 (기존 유지)
  vtol_mission:
    build:
      context: ./mission
    image: vtol_mission:local
    container_name: vtol_mission
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    devices:
      - "/dev/ttyAMA0:/dev/serial0"
    command: >
      bash -c "source /opt/ros/humble/setup.bash &&
      source /ros2_ws/install/setup.bash &&
      ros2 launch vtol_mission takeoff.launch.py fcu_url:=/dev/serial0:57600 system_id:=255 component_id:=240"

  # 2. AI 영상 노드 (Hailo-8 Vision)
  siyi_vision:
    build:
      context: ./vision_project
    image: siyi_vision:local
    container_name: siyi_vision
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    
    environment:
      - GST_DEBUG=0
      - GST_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/gstreamer-1.0
      - LD_LIBRARY_PATH=/usr/lib/aarch64-linux-gnu:/usr/lib

    devices:
      - "/dev/hailo0:/dev/hailo0"
    
    volumes:
      - /dev:/dev
      # (1) 코드 마운트
      - ./vision_project/siyi_pose_node.py:/root/ws/siyi_pose_node.py
      
      # (2) [핵심 수정] 심볼릭 링크 문제 해결!
      # 폴더를 통째로 넘기지 말고, 호스트에 있는 파일을 도커의 /root/model.hef 위치에 직접 꽂습니다.
      - /home/sw/hailo-rpi5-examples/resources/models/hailo8/yolov8m_pose.hef:/root/model.hef:ro
      
      # (3) 시스템 라이브러리 경로
      - /usr/lib:/host_usr_lib:ro

    # [실행 명령] 모델 찾기(find) 제거! 이미 /root/model.hef에 파일이 있으니까요.
    command:
      - bash
      - -c
      - |
        set -e

        echo "--- Setting up Hailo Vision Node ---"
        rm -rf /root/.cache/gstreamer-1.0

        echo "1. Copying Libraries..."
        # 라이브러리 복사 (기존과 동일)
        cp -fp /host_usr_lib/libhailort.so* /usr/lib/aarch64-linux-gnu/
        cp -fp /host_usr_lib/aarch64-linux-gnu/libgsthailometa.so* /usr/lib/aarch64-linux-gnu/ || true
        cp -fp /host_usr_lib/aarch64-linux-gnu/libhailo_tracker.so* /usr/lib/aarch64-linux-gnu/ || true
        cp -fp /host_usr_lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailo.so /usr/lib/aarch64-linux-gnu/gstreamer-1.0/
        cp -fp /host_usr_lib/aarch64-linux-gnu/gstreamer-1.0/libgsthailotools.so /usr/lib/aarch64-linux-gnu/gstreamer-1.0/

        echo "2. Refreshing System..."
        ldconfig

        echo "3. Verifying Model File..."
        # 파일이 잘 꽂혔는지 확인
        ls -l /root/model.hef || (echo "CRITICAL: Model mount failed" && exit 1)

        echo "4. Starting ROS 2 Node..."
        # 바로 실행
        python3 /root/ws/siyi_pose_node.py --ros-args -p hef_path:=/root/model.hef
